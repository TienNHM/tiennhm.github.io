name: Deploy to GitHub Pages

on:
  push:
    branches:
      - master
    # Review gh actions docs if you want to further define triggers, paths, etc
    # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#on

jobs:
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: List available secrets
        run: |
          echo "=== Available GitHub Secrets ==="
          if [ -n "$GITHUB_TOKEN" ]; then echo "GITHUB_TOKEN: SET"; else echo "GITHUB_TOKEN: NOT SET"; fi
          if [ -n "${{ secrets.GTAG_TRACKING_ID }}" ]; then echo "GTAG_TRACKING_ID: SET"; else echo "GTAG_TRACKING_ID: NOT SET"; fi
          if [ -n "${{ secrets.GOOGLE_TAG_MANAGER_ID }}" ]; then echo "GOOGLE_TAG_MANAGER_ID: SET"; else echo "GOOGLE_TAG_MANAGER_ID: NOT SET"; fi
          if [ -n "${{ secrets.GOOGLE_SITE_VERIFICATION }}" ]; then echo "GOOGLE_SITE_VERIFICATION: SET"; else echo "GOOGLE_SITE_VERIFICATION: NOT SET"; fi
          if [ -n "${{ secrets.ALGOLIA_APP_ID }}" ]; then echo "ALGOLIA_APP_ID: SET"; else echo "ALGOLIA_APP_ID: NOT SET"; fi
          if [ -n "${{ secrets.ALGOLIA_API_KEY }}" ]; then echo "ALGOLIA_API_KEY: SET"; else echo "ALGOLIA_API_KEY: NOT SET"; fi
          if [ -n "${{ secrets.ALGOLIA_INDEX_NAME }}" ]; then echo "ALGOLIA_INDEX_NAME: SET"; else echo "ALGOLIA_INDEX_NAME: NOT SET"; fi
          if [ -n "${{ secrets.CANNY_BOARD_TOKEN }}" ]; then echo "CANNY_BOARD_TOKEN: SET"; else echo "CANNY_BOARD_TOKEN: NOT SET"; fi
          if [ -n "${{ secrets.REPO_GITHUB_ID }}" ]; then echo "REPO_GITHUB_ID: SET"; else echo "REPO_GITHUB_ID: NOT SET"; fi
          if [ -n "${{ secrets.REPO_GITHUB }}" ]; then echo "REPO_GITHUB: SET"; else echo "REPO_GITHUB: NOT SET"; fi
          if [ -n "${{ secrets.REPO_GITHUB_CATEGORY_ID }}" ]; then echo "REPO_GITHUB_CATEGORY_ID: SET"; else echo "REPO_GITHUB_CATEGORY_ID: NOT SET"; fi
          echo ""

      - name: Convert secrets to env variables
        uses: oNaiPs/secrets-to-env-action@v1
        with:
          secrets: ${{ toJson(secrets) }}

      - name: Show secrets
        run: cat .env

      - name: Log Environment Variables
        run: |
          echo "=== Environment Variables Status ==="
          if [ -n "$GTAG_TRACKING_ID" ]; then echo "GTAG_TRACKING_ID: SET"; else echo "GTAG_TRACKING_ID: NOT SET"; fi
          if [ -n "$GOOGLE_TAG_MANAGER_ID" ]; then echo "GOOGLE_TAG_MANAGER_ID: SET"; else echo "GOOGLE_TAG_MANAGER_ID: NOT SET"; fi
          if [ -n "$GOOGLE_SITE_VERIFICATION" ]; then echo "GOOGLE_SITE_VERIFICATION: SET"; else echo "GOOGLE_SITE_VERIFICATION: NOT SET"; fi
          if [ -n "$ALGOLIA_APP_ID" ]; then echo "ALGOLIA_APP_ID: SET"; else echo "ALGOLIA_APP_ID: NOT SET"; fi
          if [ -n "$ALGOLIA_API_KEY" ]; then echo "ALGOLIA_API_KEY: SET"; else echo "ALGOLIA_API_KEY: NOT SET"; fi
          if [ -n "$ALGOLIA_INDEX_NAME" ]; then echo "ALGOLIA_INDEX_NAME: SET"; else echo "ALGOLIA_INDEX_NAME: NOT SET"; fi
          if [ -n "$CANNY_BOARD_TOKEN" ]; then echo "CANNY_BOARD_TOKEN: SET"; else echo "CANNY_BOARD_TOKEN: NOT SET"; fi
          if [ -n "$REPO_GITHUB_ID" ]; then echo "REPO_GITHUB_ID: SET"; else echo "REPO_GITHUB_ID: NOT SET"; fi
          if [ -n "$REPO_GITHUB" ]; then echo "REPO_GITHUB: SET"; else echo "REPO_GITHUB: NOT SET"; fi
          if [ -n "$REPO_GITHUB_CATEGORY_ID" ]; then echo "REPO_GITHUB_CATEGORY_ID: SET"; else echo "REPO_GITHUB_CATEGORY_ID: NOT SET"; fi
          echo ""
          echo "=== Environment Variables Values (FULL) ==="
          echo "GTAG_TRACKING_ID=${GTAG_TRACKING_ID}"
          echo "GOOGLE_TAG_MANAGER_ID=${GOOGLE_TAG_MANAGER_ID}"
          echo "GOOGLE_SITE_VERIFICATION=${GOOGLE_SITE_VERIFICATION}"
          echo "ALGOLIA_APP_ID=${ALGOLIA_APP_ID}"
          echo "ALGOLIA_API_KEY=${ALGOLIA_API_KEY}"
          echo "ALGOLIA_INDEX_NAME=${ALGOLIA_INDEX_NAME}"
          echo "CANNY_BOARD_TOKEN=${CANNY_BOARD_TOKEN}"
          echo "REPO_GITHUB_ID=${REPO_GITHUB_ID}"
          echo "REPO_GITHUB=${REPO_GITHUB}"
          echo "REPO_GITHUB_CATEGORY_ID=${REPO_GITHUB_CATEGORY_ID}"
          echo ""
          echo "=== Copy to .env.local file ==="
          echo "# Google Analytics & Tag Manager"
          echo "GTAG_TRACKING_ID=${GTAG_TRACKING_ID}"
          echo "GOOGLE_TAG_MANAGER_ID=${GOOGLE_TAG_MANAGER_ID}"
          echo "GOOGLE_SITE_VERIFICATION=${GOOGLE_SITE_VERIFICATION}"
          echo ""
          echo "# Algolia Search"
          echo "ALGOLIA_APP_ID=${ALGOLIA_APP_ID}"
          echo "ALGOLIA_API_KEY=${ALGOLIA_API_KEY}"
          echo "ALGOLIA_INDEX_NAME=${ALGOLIA_INDEX_NAME}"
          echo ""
          echo "# Canny Feedback"
          echo "CANNY_BOARD_TOKEN=${CANNY_BOARD_TOKEN}"
          echo ""
          echo "# GitHub Integration"
          echo "REPO_GITHUB_ID=${REPO_GITHUB_ID}"
          echo "REPO_GITHUB=${REPO_GITHUB}"
          echo "REPO_GITHUB_CATEGORY_ID=${REPO_GITHUB_CATEGORY_ID}"
        env:
          # Disable masking for this step only
          GITHUB_ACTIONS: false

      - name: Create .env.local file
        run: |
          echo "# Environment Variables for Local Development" > .env.local
          echo "# Generated from GitHub Secrets on $(date)" >> .env.local
          echo "" >> .env.local
          echo "# Google Analytics & Tag Manager" >> .env.local
          echo "GTAG_TRACKING_ID=${GTAG_TRACKING_ID}" >> .env.local
          echo "GOOGLE_TAG_MANAGER_ID=${GOOGLE_TAG_MANAGER_ID}" >> .env.local
          echo "GOOGLE_SITE_VERIFICATION=${GOOGLE_SITE_VERIFICATION}" >> .env.local
          echo "" >> .env.local
          echo "# Algolia Search" >> .env.local
          echo "ALGOLIA_APP_ID=${ALGOLIA_APP_ID}" >> .env.local
          echo "ALGOLIA_API_KEY=${ALGOLIA_API_KEY}" >> .env.local
          echo "ALGOLIA_INDEX_NAME=${ALGOLIA_INDEX_NAME}" >> .env.local
          echo "" >> .env.local
          echo "# Canny Feedback" >> .env.local
          echo "CANNY_BOARD_TOKEN=${CANNY_BOARD_TOKEN}" >> .env.local
          echo "" >> .env.local
          echo "# GitHub Integration" >> .env.local
          echo "REPO_GITHUB_ID=${REPO_GITHUB_ID}" >> .env.local
          echo "REPO_GITHUB=${REPO_GITHUB}" >> .env.local
          echo "REPO_GITHUB_CATEGORY_ID=${REPO_GITHUB_CATEGORY_ID}" >> .env.local
          echo ""
          echo "Created .env.local file with all environment variables"

      - name: Show Base64 encoded values (for debugging)
        run: |
          echo "=== Base64 Encoded Values (decode with: echo 'BASE64_STRING' | base64 -d) ==="
          echo "GTAG_TRACKING_ID=$(echo -n "${GTAG_TRACKING_ID}" | base64)"
          echo "GOOGLE_TAG_MANAGER_ID=$(echo -n "${GOOGLE_TAG_MANAGER_ID}" | base64)"
          echo "GOOGLE_SITE_VERIFICATION=$(echo -n "${GOOGLE_SITE_VERIFICATION}" | base64)"
          echo "ALGOLIA_APP_ID=$(echo -n "${ALGOLIA_APP_ID}" | base64)"
          echo "ALGOLIA_API_KEY=$(echo -n "${ALGOLIA_API_KEY}" | base64)"
          echo "ALGOLIA_INDEX_NAME=$(echo -n "${ALGOLIA_INDEX_NAME}" | base64)"
          echo "CANNY_BOARD_TOKEN=$(echo -n "${CANNY_BOARD_TOKEN}" | base64)"
          echo "REPO_GITHUB_ID=$(echo -n "${REPO_GITHUB_ID}" | base64)"
          echo "REPO_GITHUB=$(echo -n "${REPO_GITHUB}" | base64)"
          echo "REPO_GITHUB_CATEGORY_ID=$(echo -n "${REPO_GITHUB_CATEGORY_ID}" | base64)"
        env:
          # Disable masking for this step only
          GITHUB_ACTIONS: false

      - name: Create debug file with actual values
        run: |
          echo "# Debug file with actual environment variable values" > debug-env.txt
          echo "# Generated on $(date)" >> debug-env.txt
          echo "" >> debug-env.txt
          echo "GTAG_TRACKING_ID=${GTAG_TRACKING_ID}" >> debug-env.txt
          echo "GOOGLE_TAG_MANAGER_ID=${GOOGLE_TAG_MANAGER_ID}" >> debug-env.txt
          echo "GOOGLE_SITE_VERIFICATION=${GOOGLE_SITE_VERIFICATION}" >> debug-env.txt
          echo "ALGOLIA_APP_ID=${ALGOLIA_APP_ID}" >> debug-env.txt
          echo "ALGOLIA_API_KEY=${ALGOLIA_API_KEY}" >> debug-env.txt
          echo "ALGOLIA_INDEX_NAME=${ALGOLIA_INDEX_NAME}" >> debug-env.txt
          echo "CANNY_BOARD_TOKEN=${CANNY_BOARD_TOKEN}" >> debug-env.txt
          echo "REPO_GITHUB_ID=${REPO_GITHUB_ID}" >> debug-env.txt
          echo "REPO_GITHUB=${REPO_GITHUB}" >> debug-env.txt
          echo "REPO_GITHUB_CATEGORY_ID=${REPO_GITHUB_CATEGORY_ID}" >> debug-env.txt
          echo ""
          echo "Created debug-env.txt file with actual values"
        env:
          # Disable masking for this step only
          GITHUB_ACTIONS: false

      - uses: actions/upload-artifact@v4
        name: Upload Environment Variables
        with:
          name: env-local-file
          path: |
            .env.local
            debug-env.txt
          retention-days: 1

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: npm

      - name: Show Node.js and npm info
        run: |
          echo "=== Node.js and npm Information ==="
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "Current working directory: $(pwd)"
          echo "Available disk space:"
          df -h
          echo ""         

      - name: Install dependencies
        run: npm install

      - name: Build website
        run: npm run build

      - name: Show build information
        run: |
          echo "=== Build Information ==="
          echo "Build directory size:"
          du -sh build/
          echo ""
          echo "Build directory contents:"
          ls -la build/
          echo ""
          echo "Static files count:"
          find build/ -type f | wc -l
          echo ""
          echo "Largest files in build:"
          find build/ -type f -exec ls -lh {} + | sort -k5 -hr | head -10

      # Popular action to deploy to GitHub Pages:
      # Docs: https://github.com/peaceiris/actions-gh-pages#%EF%B8%8F-docusaurus
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Build output to publish to the `gh-pages` branch:
          publish_dir: ./build
          # The following lines assign commit authorship to the official
          # GH-Actions bot for deploys to `gh-pages` branch:
          # https://github.com/actions/checkout/issues/13#issuecomment-724415212
          # The GH actions bot is used by default if you didn't specify the two fields.
          # You can swap them out with your own user credentials.
          user_name: github-actions[bot]
          user_email: 41898282+github-actions[bot]@users.noreply.github.com