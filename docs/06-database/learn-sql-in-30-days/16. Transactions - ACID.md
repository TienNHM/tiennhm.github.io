---
title: 16. Transactions - ACID
slug: 16-transactions-acid
description: Gi·ªõi thi·ªáu v·ªÅ Transactions trong SQL, c√°ch s·ª≠ d·ª•ng v√† ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n d·ªØ li·ªáu v·ªõi ACID.
image: https://tiennhm.github.io/img/docs/database.jpg
sidebar_position: 16
# sidebar_class_name: hidden
tags:
    - database
    - sql
    - learn-sql
    - roadmap
    - dbms
keywords: [database, sql, learn-sql, roadmap, dbms]
enableComments: true # for Gisqus comments, set to true
draft: false # set to true to hide this post from the site
---

> M·ª•c ti√™u b√†i h·ªçc: Gi·ªõi thi·ªáu v·ªÅ Transactions trong SQL, c√°ch s·ª≠ d·ª•ng v√† ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n d·ªØ li·ªáu v·ªõi ACID.

## **1Ô∏è‚É£ Transactions l√† g√¨?**  
**Transaction (Giao d·ªãch)** trong SQL l√† m·ªôt t·∫≠p h·ª£p c√°c l·ªánh SQL ƒë∆∞·ª£c th·ª±c hi·ªán nh∆∞ **m·ªôt ƒë∆°n v·ªã c√¥ng vi·ªác**.  
- **N·∫øu t·∫•t c·∫£ l·ªánh th√†nh c√¥ng**, thay ƒë·ªïi s·∫Ω ƒë∆∞·ª£c l∆∞u (**COMMIT**).  
- **N·∫øu c√≥ l·ªói x·∫£y ra**, t·∫•t c·∫£ thay ƒë·ªïi s·∫Ω b·ªã h·ªßy (**ROLLBACK**).  

üí° **V√≠ d·ª• th·ª±c t·∫ø:**  
- Chuy·ªÉn ti·ªÅn gi·ªØa 2 t√†i kho·∫£n (**r√∫t ti·ªÅn t·ª´ A, c·ªông ti·ªÅn v√†o B**).  
- ƒê·∫∑t v√© m√°y bay (**tr·ª´ ch·ªó tr·ªëng, t·∫°o booking, c·∫≠p nh·∫≠t l·ªãch tr√¨nh**).  
- ƒê·∫∑t h√†ng (**tr·ª´ kho, t·∫°o ƒë∆°n, ghi l·ªãch s·ª≠ giao d·ªãch**).  

---

## **2Ô∏è‚É£ T√≠nh ch·∫•t ACID c·ªßa Transactions**  
Transactions ph·∫£i tu√¢n th·ªß **ACID** ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn d·ªØ li·ªáu.  

| **T√≠nh ch·∫•t**                    | **√ù nghƒ©a**                                                   |
|----------------------------------|---------------------------------------------------------------|
| **Atomicity** (T√≠nh nguy√™n t·ª≠)   | To√†n b·ªô transaction **th√†nh c√¥ng ho·∫∑c th·∫•t b·∫°i ho√†n to√†n**.   |
| **Consistency** (T√≠nh nh·∫•t qu√°n) | Database **kh√¥ng r∆°i v√†o tr·∫°ng th√°i l·ªói** d√π c√≥ l·ªói x·∫£y ra.   |
| **Isolation** (T√≠nh ƒë·ªôc l·∫≠p)     | Transactions ch·∫°y song song **kh√¥ng l√†m ·∫£nh h∆∞·ªüng l·∫´n nhau**. |
| **Durability** (T√≠nh b·ªÅn v·ªØng)   | Sau khi `COMMIT`, d·ªØ li·ªáu s·∫Ω **ƒë∆∞·ª£c l∆∞u vƒ©nh vi·ªÖn**.          |

üí° **V√≠ d·ª• minh h·ªça:**  
- N·∫øu b·∫°n r√∫t 500K t·ª´ ATM nh∆∞ng m√°y b·ªã l·ªói **sau khi tr·ª´ ti·ªÅn t√†i kho·∫£n**, h·ªá th·ªëng ph·∫£i `ROLLBACK` ƒë·ªÉ b·∫°n kh√¥ng m·∫•t ti·ªÅn.  

---

## **3Ô∏è‚É£ C√°ch s·ª≠ d·ª•ng Transactions trong SQL**  

### **üîπ L·ªánh c∆° b·∫£n**
```sql
BEGIN;  -- B·∫Øt ƒë·∫ßu transaction
UPDATE accounts SET balance = balance - 500 WHERE id = 1; -- Tr·ª´ ti·ªÅn t√†i kho·∫£n A
UPDATE accounts SET balance = balance + 500 WHERE id = 2; -- C·ªông ti·ªÅn t√†i kho·∫£n B
COMMIT; -- X√°c nh·∫≠n giao d·ªãch
```
üëâ N·∫øu t·∫•t c·∫£ l·ªánh th√†nh c√¥ng, `COMMIT` s·∫Ω l∆∞u thay ƒë·ªïi vƒ©nh vi·ªÖn.

### **üîπ X·ª≠ l√Ω l·ªói v·ªõi ROLLBACK**
```sql
BEGIN;
UPDATE accounts SET balance = balance - 500 WHERE id = 1;

-- Gi·∫£ s·ª≠ c√≥ l·ªói x·∫£y ra khi c·ªông ti·ªÅn v√†o t√†i kho·∫£n B
UPDATE accounts SET balance = balance + 500 WHERE id = 99999; -- ID kh√¥ng t·ªìn t·∫°i!

ROLLBACK; -- H·ªßy to√†n b·ªô giao d·ªãch n·∫øu c√≥ l·ªói
```
üëâ N·∫øu c√≥ l·ªói, `ROLLBACK` s·∫Ω **kh√¥i ph·ª•c d·ªØ li·ªáu v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu**.

---

## **4Ô∏è‚É£ M√¥ ph·ªèng giao d·ªãch ng√¢n h√†ng** üè¶  

### **üìå B·∫£ng `accounts`**
```sql
CREATE TABLE accounts (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    balance DECIMAL(10,2) NOT NULL
);
```
### **üîπ Th√™m d·ªØ li·ªáu m·∫´u**
```sql
INSERT INTO accounts (name, balance) VALUES ('Alice', 1000), ('Bob', 500);
```

### **üîπ M√¥ ph·ªèng chuy·ªÉn 200 t·ª´ Alice ‚Üí Bob**
```sql
BEGIN;

UPDATE accounts SET balance = balance - 200 WHERE name = 'Alice';

UPDATE accounts SET balance = balance + 200 WHERE name = 'Bob';

COMMIT;
```
üëâ N·∫øu m·ªçi th·ª© **ƒë√∫ng**, `COMMIT` s·∫Ω l∆∞u thay ƒë·ªïi.  
üëâ N·∫øu c√≥ l·ªói (v√≠ d·ª•: t√†i kho·∫£n kh√¥ng t·ªìn t·∫°i), **ch√∫ng ta c·∫ßn `ROLLBACK`**.  

### **üîπ Ki·ªÉm tra k·∫øt qu·∫£**
```sql
SELECT * FROM accounts;
```

---

## **5Ô∏è‚É£ Ki·ªÉm so√°t m·ª©c ƒë·ªô Isolation trong Transactions**  
SQL h·ªó tr·ª£ nhi·ªÅu m·ª©c ƒë·ªô **Isolation** ƒë·ªÉ ki·ªÉm so√°t ƒë·ªô an to√†n c·ªßa Transactions.  

| **M·ª©c Isolation**    | **Nguy c∆° l·ªói** |
|----------------------|----------------|
| **READ UNCOMMITTED** | C√≥ th·ªÉ ƒë·ªçc d·ªØ li·ªáu ch∆∞a `COMMIT` (kh√¥ng an to√†n). |
| **READ COMMITTED**   | Ch·ªâ ƒë·ªçc d·ªØ li·ªáu ƒë√£ `COMMIT` (m·∫∑c ƒë·ªãnh trong nhi·ªÅu h·ªá qu·∫£n tr·ªã CSDL). |
| **REPEATABLE READ**  | C√πng m·ªôt `SELECT` trong transaction **lu√¥n tr·∫£ v·ªÅ c√πng m·ªôt k·∫øt qu·∫£**. |
| **SERIALIZABLE**     | C·ª±c k·ª≥ ch·∫∑t ch·∫Ω, ngƒÉn m·ªçi transaction kh√°c can thi·ªáp. |

**V√≠ d·ª•:**  
```sql
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
BEGIN;
-- C√°c c√¢u l·ªánh SQL ·ªü m·ª©c Isolation cao nh·∫•t
COMMIT;
```

---

## **6Ô∏è‚É£ B√†i t·∫≠p th·ª±c h√†nh üéØ**  

### **‚úÖ B√†i 1: Chuy·ªÉn ti·ªÅn gi·ªØa hai t√†i kho·∫£n**
Vi·∫øt transaction chuy·ªÉn 300 t·ª´ **Bob ‚Üí Alice**. N·∫øu t√†i kho·∫£n kh√¥ng ƒë·ªß ti·ªÅn, `ROLLBACK`.  

üí° **G·ª£i √Ω l·ªùi gi·∫£i:**
- Ki·ªÉm tra s·ªë d∆∞ tr∆∞·ªõc khi tr·ª´ ti·ªÅn.
- N·∫øu s·ªë d∆∞ **kh√¥ng ƒë·ªß**, g·ªçi `ROLLBACK`.
- N·∫øu h·ª£p l·ªá, c·∫≠p nh·∫≠t s·ªë d∆∞ v√† `COMMIT`.

```sql
BEGIN;
-- Ki·ªÉm tra s·ªë d∆∞
SELECT balance INTO @bob_balance FROM accounts WHERE name = 'Bob';

IF @bob_balance < 300 THEN
    ROLLBACK;
ELSE
    UPDATE accounts SET balance = balance - 300 WHERE name = 'Bob';
    UPDATE accounts SET balance = balance + 300 WHERE name = 'Alice';
    COMMIT;
END IF;
```

---

### **‚úÖ B√†i 2: M√¥ ph·ªèng ƒë·∫∑t h√†ng**
Gi·∫£ s·ª≠ ch√∫ng ta c√≥ b·∫£ng `products (id, name, stock)` v√† `orders (id, product_id, quantity)`.  
Vi·∫øt transaction ƒë·ªÉ:  
- Tr·ª´ `stock` c·ªßa s·∫£n ph·∫©m.  
- T·∫°o b·∫£n ghi trong b·∫£ng `orders`.  
- N·∫øu c√≥ l·ªói, `ROLLBACK`.  

üí° **G·ª£i √Ω l·ªùi gi·∫£i:**
```sql
BEGIN;

-- Ki·ªÉm tra s·∫£n ph·∫©m c√≤n h√†ng kh√¥ng
SELECT stock INTO @stock FROM products WHERE id = 1;

IF @stock < 1 THEN
    ROLLBACK;
ELSE
    -- Tr·ª´ stock
    UPDATE products SET stock = stock - 1 WHERE id = 1;

    -- T·∫°o ƒë∆°n h√†ng
    INSERT INTO orders (product_id, quantity) VALUES (1, 1);

    COMMIT;
END IF;
```

---

### **‚úÖ B√†i 3: Ki·ªÉm tra hi·ªáu su·∫•t Transaction**
D√πng `EXPLAIN ANALYZE` ƒë·ªÉ ki·ªÉm tra hi·ªáu su·∫•t truy v·∫•n khi d√πng transaction.  

üí° **G·ª£i √Ω l·ªùi gi·∫£i:**
```sql
EXPLAIN ANALYZE 
BEGIN;
UPDATE accounts SET balance = balance - 500 WHERE id = 1;
UPDATE accounts SET balance = balance + 500 WHERE id = 2;
COMMIT;
```
üëâ K·∫øt qu·∫£ gi√∫p x√°c ƒë·ªãnh c√≥ c·∫ßn th√™m **INDEX** ƒë·ªÉ t·ªëi ∆∞u kh√¥ng.

---

## **üéØ T√≥m t·∫Øt b√†i h·ªçc Ng√†y 16**  
‚úÖ **Transactions** gi√∫p ƒë·∫£m b·∫£o t·∫•t c·∫£ c√°c l·ªánh **th√†nh c√¥ng ho·∫∑c b·ªã h·ªßy to√†n b·ªô**.  
‚úÖ **ACID** ƒë·∫£m b·∫£o d·ªØ li·ªáu kh√¥ng b·ªã l·ªói khi c√≥ nhi·ªÅu giao d·ªãch ƒë·ªìng th·ªùi.  
‚úÖ D√πng `COMMIT` ƒë·ªÉ l∆∞u, `ROLLBACK` ƒë·ªÉ h·ªßy n·∫øu c√≥ l·ªói.  
‚úÖ **Th·ª±c h√†nh:** Chuy·ªÉn ti·ªÅn, ƒë·∫∑t h√†ng, ki·ªÉm so√°t m·ª©c ƒë·ªô Isolation.  

---

üöÄ **Ng√†y mai:** Stored Procedures & Functions.

üìå **L·ªô tr√¨nh:** [H·ªçc SQL trong 30 ng√†y](00.%2030-Day%20SQL%20Learning%20Roadmap.md).  