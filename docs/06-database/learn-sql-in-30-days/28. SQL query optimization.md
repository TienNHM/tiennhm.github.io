---
title: 28. SQL query optimization
slug: 28-sql-query-optimization
description: HÆ°á»›ng dáº«n tá»‘i Æ°u hÃ³a truy váº¥n SQL, phÃ¢n tÃ­ch truy váº¥n vá»›i EXPLAIN ANALYZE, trÃ¡nh lá»—i phá»• biáº¿n khi viáº¿t SQL, táº­n dá»¥ng Index, Partition, Caching Ä‘á»ƒ tÄƒng hiá»‡u suáº¥t.
image: https://tiennhm.github.io/img/docs/database.jpg
sidebar_position: 28
# sidebar_class_name: hidden
tags:
    - database
    - sql
    - learn-sql
    - roadmap
    - dbms
keywords: [database, sql, learn-sql, roadmap, dbms]
enableComments: true # for Gisqus comments, set to true
draft: false # set to true to hide this post from the site
---

# ğŸ“Œ **NgÃ y 28: Tá»‘i Æ¯u HÃ³a Truy Váº¥n & Debug SQL NÃ¢ng Cao**  

## **1ï¸âƒ£ Giá»›i Thiá»‡u**  
Viáº¿t truy váº¥n SQL hiá»‡u quáº£ khÃ´ng chá»‰ giÃºp tÄƒng tá»‘c Ä‘á»™ xá»­ lÃ½ dá»¯ liá»‡u mÃ  cÃ²n giáº£m táº£i há»‡ thá»‘ng. Äá»ƒ tá»‘i Æ°u hÃ³a truy váº¥n, chÃºng ta cáº§n:  
âœ… **PhÃ¢n tÃ­ch truy váº¥n báº±ng `EXPLAIN ANALYZE`** Ä‘á»ƒ hiá»ƒu SQL Engine xá»­ lÃ½ dá»¯ liá»‡u nhÆ° tháº¿ nÃ o.  
âœ… **TrÃ¡nh cÃ¡c lá»—i phá»• biáº¿n khi viáº¿t SQL** (dÃ¹ng sai `JOIN`, láº¡m dá»¥ng `ORDER BY`).  
âœ… **Táº­n dá»¥ng Index, Partition, Caching** Ä‘á»ƒ tÄƒng hiá»‡u suáº¥t.  

ğŸ’¡ **Má»¥c tiÃªu:** Há»c cÃ¡ch **debug SQL**, hiá»ƒu **cÃ¡ch tá»‘i Æ°u hÃ³a tá»«ng cÃ¢u lá»‡nh** vÃ  so sÃ¡nh cÃ¡c chiáº¿n lÆ°á»£c viáº¿t SQL tá»‘i Æ°u.  

---

## **2ï¸âƒ£ PhÃ¢n TÃ­ch Truy Váº¥n SQL Vá»›i `EXPLAIN ANALYZE`**  
### âœ… **2.1. `EXPLAIN ANALYZE` LÃ  GÃ¬?**  
ğŸ”¹ `EXPLAIN` giÃºp kiá»ƒm tra **káº¿ hoáº¡ch thá»±c thi truy váº¥n (Query Execution Plan)**.  
ğŸ”¹ `EXPLAIN ANALYZE` cháº¡y truy váº¥n **tháº­t** vÃ  hiá»ƒn thá»‹ thá»i gian thá»±c thi.  

ğŸ’¡ **VÃ­ dá»¥:**  
```sql
EXPLAIN ANALYZE SELECT * FROM Orders WHERE OrderDate > '2024-01-01';
```
ğŸ” **Káº¿t quáº£ máº«u:**  
```
Seq Scan on Orders  (cost=0.00..431.00 rows=1000 width=48) (actual time=0.045..2.343 rows=120 loops=1)
```
ğŸ”¹ **Giáº£i thÃ­ch:**  
- `Seq Scan on Orders` â†’ SQL **quÃ©t toÃ n bá»™ báº£ng** (cháº­m náº¿u báº£ng lá»›n).  
- `cost=0.00..431.00` â†’ Chi phÃ­ xá»­ lÃ½ (cÃ ng nhá» cÃ ng tá»‘t).  
- `actual time=0.045..2.343` â†’ Thá»i gian thá»±c táº¿ (ms).  

ğŸ’¡ **CÃ¡ch tá»‘i Æ°u:** DÃ¹ng Index Ä‘á»ƒ trÃ¡nh quÃ©t toÃ n bá»™ báº£ng  
```sql
CREATE INDEX idx_orders_orderdate ON Orders(OrderDate);
```

---

## **3ï¸âƒ£ TrÃ¡nh CÃ¡c Lá»—i ThÆ°á»ng Gáº·p Khi Viáº¿t Truy Váº¥n SQL**  
### âœ… **3.1. TrÃ¡nh `SELECT *` Khi KhÃ´ng Cáº§n Thiáº¿t**  
ğŸ”¹ `SELECT *` **gÃ¢y lÃ£ng phÃ­ tÃ i nguyÃªn**, nháº¥t lÃ  khi báº£ng cÃ³ nhiá»u cá»™t.  

ğŸ’¡ **VÃ­ dá»¥ sai:**  
```sql
SELECT * FROM Orders WHERE OrderDate > '2024-01-01';
```
ğŸ’¡ **CÃ¡ch Ä‘Ãºng:** Chá»‰ láº¥y cá»™t cáº§n thiáº¿t  
```sql
SELECT OrderID, CustomerID FROM Orders WHERE OrderDate > '2024-01-01';
```
ğŸ”¹ **Lá»£i Ã­ch:** Giáº£m lÆ°á»£ng dá»¯ liá»‡u truyá»n táº£i, tÄƒng tá»‘c truy váº¥n.  

---

### âœ… **3.2. DÃ¹ng `JOIN` Hiá»‡u Quáº£**  
ğŸ”¹ `JOIN` sai cÃ¡ch cÃ³ thá»ƒ gÃ¢y **Cartesian Join (NhÃ¢n Ä‘á»)**, khiáº¿n SQL cháº¡y cá»±c cháº­m.  

ğŸ’¡ **VÃ­ dá»¥ sai:**  
```sql
SELECT Customers.Name, Orders.TotalAmount 
FROM Customers, Orders 
WHERE Customers.CustomerID = Orders.CustomerID; -- âŒ Lá»—i: DÃ¹ng dáº¥u pháº©y thay vÃ¬ JOIN
```
ğŸ’¡ **CÃ¡ch Ä‘Ãºng:**  
```sql
SELECT Customers.Name, Orders.TotalAmount 
FROM Customers 
INNER JOIN Orders ON Customers.CustomerID = Orders.CustomerID; -- âœ… Tá»‘i Æ°u hÆ¡n
```
ğŸ”¹ **Lá»£i Ã­ch:**  
- **TrÃ¡nh nhÃ¢n Ä‘á»** (Cartesian Product).  
- **Dá»… báº£o trÃ¬ & dá»… Ä‘á»c hÆ¡n**.  

---

### âœ… **3.3. Háº¡n Cháº¿ DÃ¹ng `ORDER BY` KhÃ´ng Cáº§n Thiáº¿t**  
ğŸ”¹ `ORDER BY` lÃ m SQL **tá»‘n CPU**, nháº¥t lÃ  trÃªn báº£ng lá»›n.  

ğŸ’¡ **VÃ­ dá»¥ sai:**  
```sql
SELECT * FROM Orders ORDER BY OrderDate;
```
ğŸ’¡ **CÃ¡ch Ä‘Ãºng:** Chá»‰ dÃ¹ng khi thá»±c sá»± cáº§n thiáº¿t  
```sql
SELECT OrderID, CustomerID FROM Orders WHERE OrderDate > '2024-01-01' ORDER BY OrderDate DESC;
```

---

## **4ï¸âƒ£ Tá»‘i Æ¯u Hiá»‡u Suáº¥t Vá»›i `INDEX`, `PARTITION`, `CACHING`**  
### âœ… **4.1. Index â€“ TÄƒng Tá»‘c TÃ¬m Kiáº¿m**  
ğŸ”¹ Index giÃºp truy váº¥n nhanh hÆ¡n, Ä‘áº·c biá»‡t vá»›i `WHERE`, `JOIN`.  

ğŸ’¡ **VÃ­ dá»¥:**  
```sql
CREATE INDEX idx_orders_orderdate ON Orders(OrderDate);
```
ğŸ”¹ **Lá»£i Ã­ch:**  
- Giáº£m thá»i gian tÃ¬m kiáº¿m tá»« **O(n) â†’ O(log n)**.  
- TÄƒng tá»‘c truy váº¥n vá»›i `WHERE OrderDate > ...`.  

---

### âœ… **4.2. Partition â€“ Xá»­ LÃ½ Dá»¯ Liá»‡u Lá»›n**  
ğŸ”¹ Náº¿u báº£ng cÃ³ hÃ ng **triá»‡u dÃ²ng**, **Partitioning** giÃºp SQL chá»‰ Ä‘á»c dá»¯ liá»‡u cáº§n thiáº¿t.  

ğŸ’¡ **VÃ­ dá»¥:** Chia báº£ng `Orders` theo nÄƒm  
```sql
CREATE TABLE Orders_2024 PARTITION OF Orders FOR VALUES FROM ('2024-01-01') TO ('2024-12-31');
```
ğŸ”¹ **Lá»£i Ã­ch:**  
- Giáº£m sá»‘ dÃ²ng pháº£i quÃ©t.  
- Nhanh hÆ¡n so vá»›i quÃ©t toÃ n bá»™ báº£ng.  

---

### âœ… **4.3. Caching â€“ LÆ°u Káº¿t Quáº£ Äá»ƒ TrÃ¡nh Cháº¡y Láº¡i**  
ğŸ”¹ Náº¿u truy váº¥n cháº¡y nhiá»u láº§n vá»›i dá»¯ liá»‡u Ã­t thay Ä‘á»•i, **dÃ¹ng Materialized View hoáº·c Redis Cache**.  

ğŸ’¡ **VÃ­ dá»¥:**  
```sql
CREATE MATERIALIZED VIEW OrderSummary AS 
SELECT CustomerID, SUM(TotalAmount) AS TotalSpent 
FROM Orders GROUP BY CustomerID;
```
ğŸ”¹ **Lá»£i Ã­ch:**  
- **Giáº£m táº£i** cho há»‡ thá»‘ng.  
- **Truy váº¥n nhanh hÆ¡n** so vá»›i tÃ­nh toÃ¡n láº¡i má»—i láº§n.  

---

## **5ï¸âƒ£ BÃ i Táº­p Thá»±c HÃ nh & Gá»£i Ã ÄÃ¡p Ãn**  
### ğŸ”¹ **BÃ i 1: PhÃ¢n tÃ­ch hiá»‡u suáº¥t truy váº¥n**  
Cho báº£ng `Orders` cÃ³ hÆ¡n **1 triá»‡u dÃ²ng**, cháº¡y lá»‡nh sau:  
```sql
EXPLAIN ANALYZE SELECT * FROM Orders WHERE OrderDate > '2024-01-01';
```
ğŸ“Œ **CÃ¢u há»i:**  
1ï¸âƒ£ Truy váº¥n nÃ y cÃ³ quÃ©t toÃ n bá»™ báº£ng khÃ´ng?  
2ï¸âƒ£ LÃ m sao Ä‘á»ƒ tá»‘i Æ°u nÃ³?  

ğŸ“ **Gá»£i Ã½ Ä‘Ã¡p Ã¡n:**  
- Náº¿u tháº¥y `Seq Scan`, nghÄ©a lÃ  Ä‘ang quÃ©t toÃ n bá»™ báº£ng â†’ **Cáº§n táº¡o Index**  
```sql
CREATE INDEX idx_orders_orderdate ON Orders(OrderDate);
```

---

### ğŸ”¹ **BÃ i 2: Viáº¿t truy váº¥n tá»‘i Æ°u hÃ³a**  
Báº£ng `Products` cÃ³ hÆ¡n **5 triá»‡u dÃ²ng**, cáº§n tÃ¬m sáº£n pháº©m bÃ¡n cháº¡y nháº¥t theo danh má»¥c.  

ğŸ’¡ **Viáº¿t truy váº¥n tá»‘i Æ°u:**  
```sql
SELECT CategoryID, ProductID, SUM(Quantity) AS TotalSold
FROM OrderDetails
GROUP BY CategoryID, ProductID
ORDER BY TotalSold DESC
LIMIT 10;
```
ğŸ“Œ **CÃ¢u há»i:**  
1ï¸âƒ£ Cáº§n Index gÃ¬ Ä‘á»ƒ tá»‘i Æ°u?  
2ï¸âƒ£ Náº¿u báº£ng quÃ¡ lá»›n, dÃ¹ng Partition nhÆ° tháº¿ nÃ o?  

ğŸ“ **Gá»£i Ã½ Ä‘Ã¡p Ã¡n:**  
- DÃ¹ng Index:  
```sql
CREATE INDEX idx_orderdetails_category_product ON OrderDetails(CategoryID, ProductID);
```
- Náº¿u dá»¯ liá»‡u lá»›n â†’ **DÃ¹ng Partition theo CategoryID**.  

---

#### ğŸ“Œ **TÃ³m táº¯t bÃ i há»c**
âœ… **DÃ¹ng `EXPLAIN ANALYZE` Ä‘á»ƒ kiá»ƒm tra hiá»‡u suáº¥t truy váº¥n.**  
âœ… **TrÃ¡nh lá»—i thÆ°á»ng gáº·p: `SELECT *`, `ORDER BY` khÃ´ng cáº§n thiáº¿t, sai `JOIN`**.  
âœ… **Táº­n dá»¥ng Index, Partition, Caching Ä‘á»ƒ tá»‘i Æ°u hÃ³a.**   

---

ğŸš€ **Tiáº¿p theo:** [Recursive Queries & Window Functions](29.%20Recursive%20Queries%20-%20Window%20Functions.md).

ğŸ“Œ **Lá»™ trÃ¬nh:** [Há»c SQL trong 30 ngÃ y](00.%2030-Day%20SQL%20Learning%20Roadmap.md).