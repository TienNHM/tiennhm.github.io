---
title: 18. Triggers
slug: 18-triggers
description: TÃ¬m hiá»ƒu cÃ¡ch sá»­ dá»¥ng Triggers Ä‘á»ƒ tá»± Ä‘á»™ng hÃ³a kiá»ƒm soÃ¡t dá»¯ liá»‡u trong SQL.
image: https://tiennhm.github.io/img/docs/database.jpg
sidebar_position: 18
tags:
    - database
    - sql
    - learn-sql
    - roadmap
    - dbms
keywords: [database, sql, learn-sql, roadmap, dbms]
enableComments: true
draft: false
---

> Má»¥c tiÃªu bÃ i há»c: Hiá»ƒu cÃ¡ch sá»­ dá»¥ng Triggers Ä‘á»ƒ tá»± Ä‘á»™ng kiá»ƒm soÃ¡t dá»¯ liá»‡u trÆ°á»›c/sau khi thay Ä‘á»•i.

## ğŸ“Œ **1. Trigger lÃ  gÃ¬?**  
**Trigger** lÃ  má»™t loáº¡i thá»§ tá»¥c tá»± Ä‘á»™ng thá»±c thi khi cÃ³ **sá»± kiá»‡n xáº£y ra trÃªn má»™t báº£ng** (INSERT, UPDATE, DELETE).  

ğŸ’¡ **á»¨ng dá»¥ng cá»§a Trigger:**  
âœ” Tá»± Ä‘á»™ng cáº­p nháº­t **tá»“n kho** khi cÃ³ Ä‘Æ¡n hÃ ng má»›i.  
âœ” Kiá»ƒm tra dá»¯ liá»‡u **trÆ°á»›c khi chÃ¨n vÃ o báº£ng**.  
âœ” Ghi log lá»‹ch sá»­ thay Ä‘á»•i dá»¯ liá»‡u.  
âœ” Kiá»ƒm soÃ¡t rÃ ng buá»™c dá»¯ liá»‡u khÃ´ng thá»ƒ thá»±c hiá»‡n báº±ng `CONSTRAINT`.  

---

## ğŸ›  **2. CÃ¡c loáº¡i Trigger trong SQL**  

| **Loáº¡i Trigger**    | **MÃ´ táº£** |
|---------------------|-----------|
| **BEFORE INSERT**   | Cháº¡y trÆ°á»›c khi chÃ¨n dá»¯ liá»‡u. |
| **AFTER INSERT**    | Cháº¡y sau khi chÃ¨n dá»¯ liá»‡u. |
| **BEFORE UPDATE**   | Cháº¡y trÆ°á»›c khi cáº­p nháº­t dá»¯ liá»‡u. |
| **AFTER UPDATE**    | Cháº¡y sau khi cáº­p nháº­t dá»¯ liá»‡u. |
| **BEFORE DELETE**   | Cháº¡y trÆ°á»›c khi xÃ³a dá»¯ liá»‡u. |
| **AFTER DELETE**    | Cháº¡y sau khi xÃ³a dá»¯ liá»‡u. |

ğŸ‘‰ **BEFORE** giÃºp kiá»ƒm tra dá»¯ liá»‡u **trÆ°á»›c khi thay Ä‘á»•i**.  
ğŸ‘‰ **AFTER** giÃºp **cáº­p nháº­t báº£ng khÃ¡c** hoáº·c **ghi log** sau khi thay Ä‘á»•i.  

---

## âš™ï¸ **3. CÃ¡ch táº¡o Trigger trong SQL**  

### **Cáº¥u trÃºc cÆ¡ báº£n**
```sql
CREATE TRIGGER trigger_name
AFTER INSERT ON table_name
FOR EACH ROW
BEGIN
    -- HÃ nh Ä‘á»™ng sáº½ Ä‘Æ°á»£c thá»±c thi
END;
```
ğŸ”¹ **FOR EACH ROW**: Thá»±c thi trigger cho tá»«ng dÃ²ng bá»‹ áº£nh hÆ°á»Ÿng.  

---

## ğŸ›’ **4. VÃ­ dá»¥ thá»±c táº¿: Cáº­p nháº­t tá»“n kho tá»± Ä‘á»™ng**  

### **1ï¸âƒ£ Táº¡o báº£ng sáº£n pháº©m (`products`)**
```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    stock INT NOT NULL
);
```

### **2ï¸âƒ£ Táº¡o báº£ng Ä‘Æ¡n hÃ ng (`orders`)**
```sql
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    product_id INT REFERENCES products(id),
    quantity INT NOT NULL
);
```

### **3ï¸âƒ£ Táº¡o Trigger cáº­p nháº­t stock sau khi Ä‘áº·t hÃ ng**
```sql
CREATE TRIGGER update_stock_after_order
AFTER INSERT ON orders
FOR EACH ROW
BEGIN
    UPDATE products
    SET stock = stock - NEW.quantity
    WHERE id = NEW.product_id;
END;
```
ğŸ”¹ Khi cÃ³ Ä‘Æ¡n hÃ ng má»›i, trigger **tá»± Ä‘á»™ng trá»« stock** sáº£n pháº©m tÆ°Æ¡ng á»©ng.  

### **4ï¸âƒ£ Kiá»ƒm tra trigger hoáº¡t Ä‘á»™ng**
```sql
INSERT INTO products (name, stock) VALUES ('Laptop', 10);
INSERT INTO orders (product_id, quantity) VALUES (1, 2);
SELECT * FROM products;
```
ğŸ‘‰ Stock cá»§a Laptop sáº½ **giáº£m tá»« 10 â†’ 8**.  

---

## ğŸš¨ **5. Kiá»ƒm soÃ¡t dá»¯ liá»‡u vá»›i BEFORE Trigger**  

### **NgÄƒn khÃ´ng cho khÃ¡ch Ä‘áº·t hÃ ng náº¿u háº¿t hÃ ng**
```sql
CREATE TRIGGER check_stock_before_order
BEFORE INSERT ON orders
FOR EACH ROW
BEGIN
    DECLARE stock_available INT;
    
    SELECT stock INTO stock_available
    FROM products WHERE id = NEW.product_id;
    
    IF stock_available < NEW.quantity THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'KhÃ´ng Ä‘á»§ hÃ ng trong kho!';
    END IF;
END;
```
ğŸ‘‰ Náº¿u sá»‘ lÆ°á»£ng Ä‘áº·t hÃ ng lá»›n hÆ¡n `stock`, **Trigger sáº½ bÃ¡o lá»—i** vÃ  khÃ´ng cho Ä‘áº·t hÃ ng.  

---

## ğŸ“œ **6. Ghi log thay Ä‘á»•i dá»¯ liá»‡u vá»›i AFTER UPDATE**  

### **1ï¸âƒ£ Táº¡o báº£ng log (`product_logs`)**
```sql
CREATE TABLE product_logs (
    id SERIAL PRIMARY KEY,
    product_id INT,
    old_stock INT,
    new_stock INT,
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### **2ï¸âƒ£ Táº¡o Trigger ghi log khi `stock` thay Ä‘á»•i**
```sql
CREATE TRIGGER log_stock_changes
AFTER UPDATE ON products
FOR EACH ROW
BEGIN
    INSERT INTO product_logs (product_id, old_stock, new_stock)
    VALUES (OLD.id, OLD.stock, NEW.stock);
END;
```
ğŸ”¹ **OLD.stock**: GiÃ¡ trá»‹ `stock` trÆ°á»›c khi cáº­p nháº­t.  
ğŸ”¹ **NEW.stock**: GiÃ¡ trá»‹ `stock` má»›i sau cáº­p nháº­t.  

ğŸ‘‰ Khi thay Ä‘á»•i tá»“n kho sáº£n pháº©m, trigger sáº½ **tá»± Ä‘á»™ng ghi log** vÃ o `product_logs`.  

---

## ğŸ¯ **7. BÃ i táº­p thá»±c hÃ nh**  

### âœ… **BÃ i 1: Táº¡o trigger cáº­p nháº­t tá»•ng sá»‘ lÆ°á»£ng hÃ ng Ä‘Ã£ bÃ¡n**
> Viáº¿t trigger cáº­p nháº­t báº£ng `sales_summary (product_id, total_sold)` má»—i khi cÃ³ Ä‘Æ¡n hÃ ng má»›i.  

ğŸ’¡ **Gá»£i Ã½ lá»i giáº£i:**
```sql
CREATE TABLE sales_summary (
    product_id INT PRIMARY KEY,
    total_sold INT DEFAULT 0
);

CREATE TRIGGER update_sales_summary
AFTER INSERT ON orders
FOR EACH ROW
BEGIN
    INSERT INTO sales_summary (product_id, total_sold)
    VALUES (NEW.product_id, NEW.quantity)
    ON DUPLICATE KEY UPDATE total_sold = total_sold + NEW.quantity;
END;
```
ğŸ‘‰ Má»—i láº§n cÃ³ Ä‘Æ¡n hÃ ng má»›i, **trigger sáº½ cáº­p nháº­t tá»•ng sá»‘ lÆ°á»£ng hÃ ng Ä‘Ã£ bÃ¡n**.  

---

### âœ… **BÃ i 2: NgÄƒn khÃ´ng cho xÃ³a sáº£n pháº©m náº¿u cÃ³ Ä‘Æ¡n hÃ ng**
> Viáº¿t trigger kiá»ƒm tra náº¿u `product_id` Ä‘Ã£ tá»“n táº¡i trong `orders`, khÃ´ng cho phÃ©p xÃ³a sáº£n pháº©m khá»i báº£ng `products`.  

ğŸ’¡ **Gá»£i Ã½ lá»i giáº£i:**
```sql
CREATE TRIGGER prevent_product_deletion
BEFORE DELETE ON products
FOR EACH ROW
BEGIN
    DECLARE order_count INT;
    
    SELECT COUNT(*) INTO order_count FROM orders WHERE product_id = OLD.id;
    
    IF order_count > 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'KhÃ´ng thá»ƒ xÃ³a sáº£n pháº©m vÃ¬ Ä‘Ã£ cÃ³ Ä‘Æ¡n hÃ ng!';
    END IF;
END;
```
ğŸ‘‰ Náº¿u sáº£n pháº©m Ä‘Ã£ cÃ³ Ä‘Æ¡n hÃ ng, trigger sáº½ bÃ¡o lá»—i vÃ  **khÃ´ng cho xÃ³a**.  

---

## ğŸ”¥ **TÃ³m táº¯t bÃ i há»c NgÃ y 18**  
âœ… **Triggers** giÃºp tá»± Ä‘á»™ng hÃ³a kiá»ƒm soÃ¡t dá»¯ liá»‡u trong SQL.  
âœ… **BEFORE Trigger** giÃºp kiá»ƒm tra dá»¯ liá»‡u **trÆ°á»›c khi thay Ä‘á»•i**.  
âœ… **AFTER Trigger** giÃºp cáº­p nháº­t báº£ng khÃ¡c hoáº·c ghi log **sau khi thay Ä‘á»•i**.  
âœ… **Thá»±c hÃ nh:** Táº¡o trigger cáº­p nháº­t tá»“n kho, ghi log thay Ä‘á»•i, ngÄƒn xÃ³a dá»¯ liá»‡u quan trá»ng.  

---

ğŸš€ **NgÃ y mai:** [Views (Báº£ng áº£o).](19.%20Views.md)

ğŸ“Œ **Lá»™ trÃ¬nh:** [Há»c SQL trong 30 ngÃ y](00.%2030-Day%20SQL%20Learning%20Roadmap.md).
