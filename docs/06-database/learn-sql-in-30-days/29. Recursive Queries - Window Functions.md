---
title: 29. Recursive Queries & Window Functions
slug: 29-recursive-queries-window-functions
description: Giá»›i thiá»‡u vá» Recursive Queries vÃ  Window Functions trong SQL, cÃ¡ch viáº¿t truy váº¥n Ä‘á»‡ quy, á»©ng dá»¥ng thá»±c táº¿, cÃ¡ch sá»­ dá»¥ng Window Functions Ä‘á»ƒ phÃ¢n tÃ­ch dá»¯ liá»‡u, xáº¿p háº¡ng, lá»c dá»¯ liá»‡u theo thá»i gian.
image: https://tiennhm.github.io/img/docs/database.jpg
sidebar_position: 29
# sidebar_class_name: hidden
tags:
    - database
    - sql
    - learn-sql
    - roadmap
    - dbms
keywords: [database, sql, learn-sql, roadmap, dbms]
enableComments: true # for Gisqus comments, set to true
draft: false # set to true to hide this post from the site
---

# ğŸ“Œ **NgÃ y 29: Recursive Queries & Window Functions**  

## **1ï¸âƒ£ Giá»›i Thiá»‡u**  
ğŸ”¹ **Recursive Queries** (`WITH RECURSIVE`) giÃºp xá»­ lÃ½ dá»¯ liá»‡u Ä‘á»‡ quy, thÆ°á»ng dÃ¹ng Ä‘á»ƒ **xá»­ lÃ½ cÃ¢y thÆ° má»¥c, cáº¥u trÃºc tá»• chá»©c, chuá»—i truy xuáº¥t dá»¯ liá»‡u**.  
ğŸ”¹ **Window Functions** (`RANK()`, `DENSE_RANK()`, `ROW_NUMBER()`) há»— trá»£ phÃ¢n tÃ­ch dá»¯ liá»‡u **mÃ  khÃ´ng lÃ m thay Ä‘á»•i sá»‘ lÆ°á»£ng dÃ²ng**, thÆ°á»ng dÃ¹ng Ä‘á»ƒ **táº¡o xáº¿p háº¡ng, nhÃ³m theo thá»i gian, tÃ¬m giÃ¡ trá»‹ trÆ°á»›c/sau**.  

ğŸ’¡ **Má»¥c tiÃªu:**  
âœ” Hiá»ƒu cÃ¡ch **viáº¿t truy váº¥n Ä‘á»‡ quy** trong SQL.  
âœ” Biáº¿t cÃ¡ch **dÃ¹ng Window Functions** Ä‘á»ƒ lÃ m bÃ¡o cÃ¡o, phÃ¢n tÃ­ch dá»¯ liá»‡u.  
âœ” á»¨ng dá»¥ng vÃ o **thá»±c táº¿ vá»›i bÃ¡o cÃ¡o doanh sá»‘, phÃ¢n tÃ­ch ngÆ°á»i dÃ¹ng**.  

---

## **2ï¸âƒ£ Recursive Queries (`WITH RECURSIVE`)**  
### âœ… **2.1. Recursive Queries lÃ  gÃ¬?**  
ğŸ”¹ Recursive Queries lÃ  truy váº¥n **tá»± gá»i láº¡i chÃ­nh nÃ³**, giÃºp xá»­ lÃ½ dá»¯ liá»‡u cÃ³ cáº¥u trÃºc cÃ¢y hoáº·c chuá»—i Ä‘á»‡ quy.  
ğŸ”¹ á»¨ng dá»¥ng phá»• biáº¿n:  
- **CÃ¢y thÆ° má»¥c (File System)**.  
- **Cáº¥u trÃºc tá»• chá»©c (Org Chart)**.  
- **Chuá»—i Markov, phÃ¢n tÃ­ch truy xuáº¥t dá»¯ liá»‡u**.  

---

### âœ… **2.2. CÃ¡ch Viáº¿t Recursive Queries**  
CÃº phÃ¡p cÆ¡ báº£n:  
```sql
WITH RECURSIVE RecursiveCTE AS (
    -- Truy váº¥n gá»‘c (Initial Query)
    SELECT ...
    UNION ALL
    -- Truy váº¥n Ä‘á»‡ quy (Recursive Query)
    SELECT ... FROM RecursiveCTE WHERE ...
)
SELECT * FROM RecursiveCTE;
```

ğŸ’¡ **VÃ­ dá»¥:** TÃ¬m cáº¥p báº­c nhÃ¢n viÃªn trong cÃ´ng ty  
```sql
WITH RECURSIVE EmployeeHierarchy AS (
    -- NhÃ¢n viÃªn cáº¥p cao nháº¥t (CEO)
    SELECT EmployeeID, ManagerID, FullName, 1 AS Level
    FROM Employees
    WHERE ManagerID IS NULL
    
    UNION ALL

    -- NhÃ¢n viÃªn cáº¥p dÆ°á»›i
    SELECT e.EmployeeID, e.ManagerID, e.FullName, eh.Level + 1
    FROM Employees e
    JOIN EmployeeHierarchy eh ON e.ManagerID = eh.EmployeeID
)
SELECT * FROM EmployeeHierarchy ORDER BY Level;
```
ğŸ”¹ **Giáº£i thÃ­ch:**  
âœ” BÆ°á»›c 1: Chá»n CEO (ManagerID = NULL).  
âœ” BÆ°á»›c 2: TÃ¬m cÃ¡c nhÃ¢n viÃªn bÃ¡o cÃ¡o cho CEO.  
âœ” BÆ°á»›c 3: Tiáº¿p tá»¥c tÃ¬m nhÃ¢n viÃªn cáº¥p dÆ°á»›i.  
âœ” Káº¿t quáº£ hiá»ƒn thá»‹ thá»© báº­c nhÃ¢n viÃªn.  

---

### âœ… **2.3. BÃ i ToÃ¡n ÄÆ°á»ng Äi Ngáº¯n Nháº¥t (Shortest Path Problem)**  
Recursive Queries cÅ©ng cÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ tÃ¬m **Ä‘Æ°á»ng Ä‘i ngáº¯n nháº¥t** trong Ä‘á»“ thá»‹.  

ğŸ’¡ **VÃ­ dá»¥:** TÃ¬m Ä‘Æ°á»ng tá»« Ä‘iá»ƒm A Ä‘áº¿n B trong báº£ng `Routes`  
```sql
WITH RECURSIVE ShortestPath AS (
    SELECT StartPoint, EndPoint, Distance FROM Routes WHERE StartPoint = 'A'
    
    UNION ALL

    SELECT r.StartPoint, r.EndPoint, sp.Distance + r.Distance
    FROM Routes r
    JOIN ShortestPath sp ON r.StartPoint = sp.EndPoint
)
SELECT * FROM ShortestPath WHERE EndPoint = 'B' ORDER BY Distance LIMIT 1;
```
ğŸ”¹ **á»¨ng dá»¥ng thá»±c táº¿:**  
âœ” TÃ¬m Ä‘Æ°á»ng Ä‘i trong **báº£n Ä‘á»“ GPS**.  
âœ” Xá»­ lÃ½ **Ä‘á»“ thá»‹ quan há»‡ ngÆ°á»i dÃ¹ng**.  

---

## **3ï¸âƒ£ Window Functions (`RANK()`, `DENSE_RANK()`, `ROW_NUMBER()`)**  
### âœ… **3.1. Window Functions LÃ  GÃ¬?**  
ğŸ”¹ Window Functions giÃºp **táº¡o chá»‰ má»¥c, xáº¿p háº¡ng, phÃ¢n tÃ­ch dá»¯ liá»‡u theo nhÃ³m** mÃ  khÃ´ng lÃ m thay Ä‘á»•i sá»‘ lÆ°á»£ng dÃ²ng.  
ğŸ”¹ á»¨ng dá»¥ng phá»• biáº¿n:  
âœ” **Xáº¿p háº¡ng há»c sinh, doanh sá»‘ bÃ¡n hÃ ng**.  
âœ” **PhÃ¢n tÃ­ch hÃ nh vi khÃ¡ch hÃ ng**.  
âœ” **Lá»c dá»¯ liá»‡u theo thá»i gian (giÃ¡ trá»‹ trÆ°á»›c/sau)**.  

---

### âœ… **3.2. PhÃ¢n Biá»‡t `RANK()`, `DENSE_RANK()`, `ROW_NUMBER()`**  
ğŸ’¡ **VÃ­ dá»¥:** Xáº¿p háº¡ng doanh sá»‘ nhÃ¢n viÃªn  
```sql
SELECT EmployeeID, FullName, Department, SalesAmount,
       RANK() OVER (PARTITION BY Department ORDER BY SalesAmount DESC) AS Rank,
       DENSE_RANK() OVER (PARTITION BY Department ORDER BY SalesAmount DESC) AS DenseRank,
       ROW_NUMBER() OVER (PARTITION BY Department ORDER BY SalesAmount DESC) AS RowNum
FROM Employees;
```
ğŸ”¹ **So sÃ¡nh káº¿t quáº£:**  
| Employee | Sales | RANK() | DENSE_RANK() | ROW_NUMBER() |  
|----------|------|--------|-------------|-------------|  
| A        | 1000 | 1      | 1           | 1           |  
| B        | 1000 | 1      | 1           | 2           |  
| C        | 900  | 3      | 2           | 3           |  

âœ” `RANK()`: Náº¿u cÃ³ giÃ¡ trá»‹ trÃ¹ng, sáº½ bá» qua sá»‘ thá»© tá»± tiáº¿p theo.  
âœ” `DENSE_RANK()`: KhÃ´ng bá» qua sá»‘ thá»© tá»±, giÃ¡ trá»‹ trÃ¹ng sáº½ cÃ¹ng háº¡ng.  
âœ” `ROW_NUMBER()`: KhÃ´ng trÃ¹ng láº·p sá»‘ thá»© tá»±.  

---

### âœ… **3.3. á»¨ng Dá»¥ng `LEAD()`, `LAG()` Äá»ƒ Láº¥y GiÃ¡ Trá»‹ TrÆ°á»›c/Sau**  
ğŸ’¡ **VÃ­ dá»¥:** So sÃ¡nh doanh sá»‘ thÃ¡ng hiá»‡n táº¡i vá»›i thÃ¡ng trÆ°á»›c  
```sql
SELECT EmployeeID, FullName, SalesMonth, SalesAmount,
       LAG(SalesAmount, 1) OVER (PARTITION BY EmployeeID ORDER BY SalesMonth) AS PreviousMonth,
       LEAD(SalesAmount, 1) OVER (PARTITION BY EmployeeID ORDER BY SalesMonth) AS NextMonth
FROM Sales;
```
ğŸ”¹ **á»¨ng dá»¥ng thá»±c táº¿:**  
âœ” So sÃ¡nh **giÃ¡ chá»©ng khoÃ¡n theo ngÃ y**.  
âœ” Xem **khÃ¡ch hÃ ng cÃ³ tÄƒng/giáº£m chi tiÃªu**.  

---

## **4ï¸âƒ£ BÃ i Táº­p Thá»±c HÃ nh & Gá»£i Ã ÄÃ¡p Ãn**  
### ğŸ”¹ **BÃ i 1: Truy váº¥n Ä‘á»‡ quy tÃ¬m cáº¥p báº­c nhÃ¢n viÃªn**  
ğŸ“Œ **YÃªu cáº§u:**  
âœ” Viáº¿t truy váº¥n láº¥y danh sÃ¡ch nhÃ¢n viÃªn theo cáº¥p báº­c trong cÃ´ng ty.  
âœ” CEO (cáº¥p 1) â†’ TrÆ°á»Ÿng phÃ²ng (cáº¥p 2) â†’ NhÃ¢n viÃªn (cáº¥p 3).  

ğŸ“ **Gá»£i Ã½ Ä‘Ã¡p Ã¡n:**  
```sql
WITH RECURSIVE EmployeeHierarchy AS (
    SELECT EmployeeID, FullName, ManagerID, 1 AS Level FROM Employees WHERE ManagerID IS NULL
    UNION ALL
    SELECT e.EmployeeID, e.FullName, e.ManagerID, eh.Level + 1
    FROM Employees e
    JOIN EmployeeHierarchy eh ON e.ManagerID = eh.EmployeeID
)
SELECT * FROM EmployeeHierarchy ORDER BY Level;
```

---

### ğŸ”¹ **BÃ i 2: Xáº¿p háº¡ng doanh sá»‘ nhÃ¢n viÃªn theo bá»™ pháº­n**  
ğŸ“Œ **YÃªu cáº§u:**  
âœ” Viáº¿t truy váº¥n xáº¿p háº¡ng doanh sá»‘ nhÃ¢n viÃªn theo phÃ²ng ban báº±ng `RANK()`, `DENSE_RANK()`.  

ğŸ“ **Gá»£i Ã½ Ä‘Ã¡p Ã¡n:**  
```sql
SELECT EmployeeID, FullName, Department, SalesAmount,
       RANK() OVER (PARTITION BY Department ORDER BY SalesAmount DESC) AS Rank
FROM Employees;
```

---

#### ğŸ“Œ **TÃ³m táº¯t bÃ i há»c**
ğŸ”¹ **Recursive Queries (`WITH RECURSIVE`)** giÃºp xá»­ lÃ½ cÃ¢y thÆ° má»¥c, tá»• chá»©c nhÃ¢n sá»±.  
ğŸ”¹ **Window Functions (`RANK()`, `ROW_NUMBER()`, `LEAD()`)** há»— trá»£ phÃ¢n tÃ­ch dá»¯ liá»‡u máº¡nh máº½.  
ğŸ”¹ **á»¨ng dá»¥ng vÃ o thá»±c táº¿: bÃ¡o cÃ¡o doanh sá»‘, phÃ¢n tÃ­ch khÃ¡ch hÃ ng, truy váº¥n Ä‘á»‡ quy.**  

---

ğŸš€ **Tiáº¿p theo:** [Database security](30.%20Database%20security.md).

ğŸ“Œ **Lá»™ trÃ¬nh:** [Há»c SQL trong 30 ngÃ y](00.%2030-Day%20SQL%20Learning%20Roadmap.md).